---
    - name: "Enroll Virtual Machines"
      # The variable definitions below seem far from ideal, however there
      # seems to be no better way to handle CSV files for looping at this time.
      #
      # Ideally with_lines would be used with an include, however that support was removed in
      # Ansible 1.6 and no direct replacement exists.
      #
      # mac_address: "{{item.split(',')[1]}}"
      # username: "{{item.split(',')[2]}}"
      # password: "{{item.split(',')[3]}}"
      # management_address: "{{item.split(',')[4]}}"
      # cpu_cores: "{{item.split(',')[5]}}"
      # memory_MB: "{{item.split(',')[6]}}"
      # disk_MB: "{{item.split(',')[7]}}"
      os_ironic:
        auth_plugin: None
        auth: None
        ironic_url: "{{ ironic_url }}"
        driver: "agent_ssh"
        # UUID determination TBD for mass enrollment.
        uuid: "{{item.split(',')[9]}}"
        state: present
        nics:
         - mac: "{{item.split(',')[0]}}"
        properties:
          cpus: "{{item.split(',')[4]}}"
          cpu_arch: "x86_64"
          ram: "{{item.split(',')[5]}}"
          disk_size: "{{item.split(',')[6]}}"
        driver_info:
          power:
            ssh_virt_type: "virsh"
            ssh_address: 127.0.0.1
            ssh_port: 22
            ssh_username: ironic
            ssh_key_filename: /home/ironic/.ssh/id_rsa
          deploy:
            deploy_kernel: "{{ deploy_kernel_url }}"
            deploy_ramdisk: "{{ deploy_ramdisk_url }}"
      delegate_to: localhost
      with_lines:
        - cat {{ baremetal_csv_file }}
